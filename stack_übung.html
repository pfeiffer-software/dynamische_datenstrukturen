<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stack-Training: Karten stapeln (LIFO)</title>
  <style>
    :root{
      --bg:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --accent:#22c55e; --info:#38bdf8; --warn:#f59e0b; --bad:#ef4444; --good:#22c55e;
      --shadow:0 12px 28px rgba(0,0,0,.35); --radius:18px;
    }
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Ubuntu,Cantarell,Helvetica Neue,Arial; background:radial-gradient(1200px 800px at 20% -10%,#0b1220,#0f172a); color:var(--text)}
    .app{display:grid;grid-template-columns:360px 1fr 420px;gap:18px;padding:24px;max-width:1500px;margin:0 auto}
    .panel{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);box-shadow:var(--shadow)}
    .panel h2{margin:0;padding:16px 18px;font-size:18px;letter-spacing:.2px;border-bottom:1px solid rgba(255,255,255,.06);background:linear-gradient(180deg,rgba(255,255,255,.035),rgba(255,255,255,.02));border-top-left-radius:var(--radius);border-top-right-radius:var(--radius)}
    .panel .content{padding:16px 18px}
    .small{color:var(--muted);font-size:12px}

    /* Aufgabenliste */
    .task{padding:12px;margin:0 0 12px;border:1px dashed rgba(255,255,255,.12);border-radius:12px;transition:filter .15s ease,transform .08s ease, border-color .15s ease;cursor:pointer}
    .task:hover{transform:translateY(-1px)}
    .task.locked{opacity:.5;pointer-events:none}
    .task.active{border-color:var(--info);box-shadow:inset 0 0 0 2px rgba(56,189,248,.35)}

    /* Karten-Pool */
    .pool{display:flex;flex-wrap:wrap;gap:12px;min-height:120px}
    .card{position:relative;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));border:2px solid transparent;border-radius:18px;padding:14px 16px;min-width:190px;max-width:280px;box-shadow:0 10px 26px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.06);cursor:pointer;user-select:none;transition:transform .08s ease,border-color .1s ease, box-shadow .1s ease, opacity .1s ease, filter .1s ease}
    .card:hover{transform:translateY(-1px); box-shadow:0 14px 32px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.08)}
    .card.selected{border-color:var(--accent); box-shadow:0 0 0 2px rgba(34,197,94,.35), 0 14px 32px rgba(0,0,0,.5)}
    .card.in-stack{opacity:.55; filter:saturate(.7); border-color:rgba(56,189,248,.35)}
    .card .title{font-weight:700;margin-bottom:6px;font-size:15px}
    .card .desc{font-size:12px;color:var(--muted)}
    .chip{position:absolute; top:8px; right:8px; padding:2px 8px; border-radius:999px; font-size:11px; border:1px solid rgba(56,189,248,.35); background:rgba(56,189,248,.15); color:#dbeafe; pointer-events:none}

    /* Stack (rechts) */
    .stack-area{display:flex;flex-direction:column;gap:12px}
    .stack-visual{
      height:480px;border:2px dashed rgba(56,189,248,.35);border-radius:16px;
      background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));
      overflow-y:auto;transition:border-color .15s ease, box-shadow .15s ease;
      position:relative;
    }
    .stack-visual.success{border-color:rgba(34,197,94,.8);box-shadow:0 0 0 3px rgba(34,197,94,.25) inset}
    .stack-visual.success-pulse{animation:successPulse .9s ease-in-out 1}
    .stack-visual.fail-shake{animation:failShake .4s ease 1, failGlow .9s ease 1}

    .stack-inner{
      display:flex;flex-direction:column;justify-content:flex-end; /* w√§chst von unten nach oben */
      gap:8px;padding:12px;min-height:100%;height:100%;box-sizing:border-box;
    }

    .stack-slot{position:relative;height:56px;border-radius:12px;background:rgba(56,189,248,.08);border:1px dashed rgba(56,189,248,.35);display:flex;align-items:center;justify-content:center;color:var(--muted)}
    .stack-slot.filled{background:linear-gradient(180deg,rgba(56,189,248,.22),rgba(56,189,248,.10));border:1px solid rgba(56,189,248,.5);color:var(--text)}
    .slot-label{position:absolute;right:12px;top:8px;font-size:11px;color:var(--muted)}
    .slot-content{width:100%; height:100%; display:flex; align-items:center; justify-content:center; font-weight:700;}

    .success-overlay{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none;}
    .success-badge{display:flex; align-items:center; gap:10px; padding:10px 14px; border-radius:999px; background:rgba(34,197,94,.15); border:1px solid rgba(34,197,94,.6); font-weight:700; backdrop-filter:blur(6px); animation:fadeSlide 1.1s ease both;}

    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    .btn{appearance:none;border:none;padding:10px 14px;border-radius:12px;background:linear-gradient(180deg,rgba(34,197,94,.35),rgba(34,197,94,.25));color:#fff;font-weight:700;box-shadow:var(--shadow);cursor:pointer;transition:transform .08s ease,filter .15s ease}
    .btn:hover{filter:brightness(1.05);transform:translateY(-1px)}
    .btn.secondary{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));color:#fff;border:1px solid rgba(255,255,255,.12)}
    .btn.info{background:linear-gradient(180deg,rgba(56,189,248,.35),rgba(56,189,248,.25));color:#fff}
    .btn.warn{background:linear-gradient(180deg,rgba(245,158,11,.35),rgba(245,158,11,.25));color:#fff}
    .btn.ghost{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));color:#fff;border:1px dashed rgba(255,255,255,.12)}
    .btn:disabled{opacity:.5;cursor:not-allowed}

    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);font-size:12px}
    .status{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .result{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);font-size:14px;min-height:20px}
    .hint{font-size:12px;color:var(--muted)}
    .footer{text-align:center;color:var(--muted);font-size:12px;padding:8px 0 16px}

    /* Toast / Push-Notification: ZENTRIERT & nur per X */
    .toasts{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:9999;
      pointer-events:none; /* verhindert Blockieren der UI, au√üer dem Toast selbst */
    }
    .toast{
      pointer-events:auto;
      display:flex; align-items:flex-start; gap:14px; max-width:560px; width:min(92vw, 560px);
      background:linear-gradient(180deg,rgba(34,197,94,.20),rgba(34,197,94,.12));
      border:1px solid rgba(34,197,94,.65);
      box-shadow:0 18px 40px rgba(0,0,0,.45);
      padding:16px 18px; border-radius:16px; color:#ecfdf5;
      animation:toastIn .28s ease-out both;
      backdrop-filter:blur(6px);
    }
    .toast .icon{font-size:22px; line-height:1; margin-top:2px}
    .toast .body{flex:1}
    .toast .title{font-weight:900; margin-bottom:6px; font-size:16px; letter-spacing:.2px}
    .toast .msg{font-size:14px; color:#d1fae5}
    .toast .close{appearance:none; border:none; background:transparent; color:#ecfdf5; cursor:pointer; font-size:18px; line-height:1}
    @keyframes toastIn{from{transform:scale(.98); opacity:0} to{transform:scale(1); opacity:1}}
    @keyframes toastOut{from{opacity:1} to{opacity:0; transform:scale(.98)}}
  </style>
</head>
<body>
  <div class="app">
    <!-- LEFT: Aufgaben -->
    <section class="panel" id="left">
      <h2>Aufgaben</h2>
      <div class="content">
        <div id="taskList"></div>
        <hr style="border:none;border-top:1px solid rgba(255,255,255,.08); margin:14px 0;">
        <button id="btnOpenCreator" class="btn ghost" disabled>Eigene Aufgabe erstellen</button>

        <!-- Creator-Form -->
        <div id="creator" class="creator" style="display:none; margin-top:12px; border:1px dashed rgba(255,255,255,.12); border-radius:12px; padding:12px">
          <div class="row" style="display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap">
            <input id="ctitle" type="text" placeholder="Titel eingeben (z. B. ‚ÄûSchulranzen packen‚Äú)" style="flex:1; padding:10px 12px; border-radius:10px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.10); color:var(--text)" />
          </div>
          <div class="row" style="display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap">
            <textarea id="cdesc" rows="2" placeholder="Kurzbeschreibung (wird wie bei den anderen Aufgaben angezeigt)" style="width:100%; padding:10px 12px; border-radius:10px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.10); color:var(--text)"></textarea>
          </div>
          <div class="row" style="display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap">
            <input id="cstepInput" type="text" placeholder="Schritt/Karte hinzuf√ºgen (POP-Reihenfolge)" style="flex:1; padding:10px 12px; border-radius:10px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.10); color:var(--text)"/>
            <button id="btnAddStep" class="btn mini">+ Hinzuf√ºgen</button>
          </div>
          <div class="steps" id="stepsList" style="margin-top:10px"></div>
          <div class="row" style="display:flex; gap:8px; margin-top:8px; justify-content:space-between">
            <button id="btnCancelCreator" class="btn secondary">Abbrechen</button>
            <button id="btnSaveTask" class="btn">Speichern & l√∂sen</button>
          </div>
          <div class="small" style="margin-top:6px;color:var(--muted)">
            Hinweis: Die Reihenfolge unten ist die <strong>POP-Reihenfolge</strong> (das, was beim korrekten <em>Pop</em> nacheinander erwartet wird).
          </div>
        </div>
      </div>
    </section>

    <!-- MIDDLE: Karten-Pool -->
    <section class="panel" id="middle">
      <h2>Karten-Pool (anklicken ‚Üí ausw√§hlen)</h2>
      <div class="content">
        <div class="pool" id="pool"></div>
        <p class="hint">Karte anklicken (gr√ºn) ‚Üí <strong>Push</strong> legt sie auf den Stack. Karten bleiben im Pool. <br>Mit <em>Pop</em> arbeitest du die Zielreihenfolge ab. <em>Peek</em> zeigt kurz das Top-Element.</p>
      </div>
    </section>

    <!-- RIGHT: Stack -->
    <section class="panel" id="right">
      <h2>Stack</h2>
      <div class="content">
        <div class="stack-area">
          <div class="stack-visual" id="stackVisual" aria-label="Stack">
            <div class="stack-inner" id="stackInner"></div>
          </div>
          <div class="toolbar">
            <button class="btn" id="btnPush">Push (ausgew√§hlte Karte)</button>
            <button class="btn info" id="btnPop">Pop</button>
            <button class="btn secondary" id="btnPeek">Peek</button>
            <button class="btn warn" id="btnReset">Zur√ºcksetzen</button>
          </div>
          <div class="result" id="result">Bereit.</div>
        </div>
      </div>
    </section>
  </div>

  <div class="footer">Stack-Training ‚Ä¢ LIFO ‚Ä¢ v4.1 (Zentraler Push)</div>

  <!-- Toast-Container -->
  <div class="toasts" id="toasts" aria-live="polite" aria-atomic="true"></div>

<script>
// =========================
// Aufgaben-Definitionen (3 Standardaufgaben)
// =========================
const TASKS = [
  {
    id: 'kaffee',
    title: 'Kaffee (French Press)',
    description: 'POP-Reihenfolge: Wasser ‚Üí Vorw√§rmen ‚Üí Mahlen ‚Üí Pulver rein ‚Üí Aufgie√üen ‚Üí Ziehen lassen ‚Üí Runterdr√ºcken ‚Üí Eingie√üen.',
    target: [
      'Wasser erhitzen',
      'Kanne vorw√§rmen',
      'Kaffeebohnen mahlen',
      'Kaffeepulver einf√ºllen',
      'Wasser aufgie√üen',
      '4 Minuten ziehen lassen',
      'Stempel langsam runterdr√ºcken',
      'Kaffee eingie√üen'
    ]
  },
  {
    id: 'informatik',
    title: 'Typische Informatikstunde',
    description: 'Arbeite die typischen Schritte in POP-Reihenfolge ab.',
    target: [
      'In die Mitte setzen (1)',
      'Aufgaben erhalten',
      'PC starten',
      'Anmelden',
      'Neuen Code herunterladen',
      'BlueJ √∂ffnen',
      'Aufgaben/Code bearbeiten',
      'In die Mitte setzen (2)',
      'L√∂sung pr√§sentieren'
    ]
  },
  {
    id: 'arith1',
    title: 'Mathe: (3 + 5) √ó 2',
    description: 'Aktionen in der POP-Reihenfolge ausf√ºhren.',
    target: [
      'Zahl 3 bereitstellen',
      'Zahl 5 bereitstellen',
      'Addieren',
      'Zahl 2 bereitstellen',
      'Multiplizieren'
    ]
  }
];

// =========================
// State & UI-Refs
// =========================
let currentTask = null;
let stack = [];           // { text }
let poppedSoFar = [];     // korrekt abgearbeitete POP-Schritte
let selectedCard = null;  // Text der aktuell ausgew√§hlten Karte
let showTop = false;      // zeigt bei Peek nur oberstes Element
let poolOrder = [];       // Reihenfolge der aktuell dargestellten Pool-Karten

const taskListEl   = document.getElementById('taskList');
const poolEl       = document.getElementById('pool');
const stackVisualEl= document.getElementById('stackVisual');
const stackInnerEl = document.getElementById('stackInner');
const resultEl     = document.getElementById('result');

const btnPush  = document.getElementById('btnPush');
const btnPop   = document.getElementById('btnPop');
const btnPeek  = document.getElementById('btnPeek');
const btnReset = document.getElementById('btnReset');

// Creator UI
const btnOpenCreator = document.getElementById('btnOpenCreator');
const creatorEl = document.getElementById('creator');
const ctitle = document.getElementById('ctitle');
const cdesc = document.getElementById('cdesc');
const cstepInput = document.getElementById('cstepInput');
const btnAddStep = document.getElementById('btnAddStep');
const stepsList = document.getElementById('stepsList');
const btnSaveTask = document.getElementById('btnSaveTask');
const btnCancelCreator = document.getElementById('btnCancelCreator');

// =========================
// Helpers
// =========================
function shuffle(arr){
  const a = [...arr];
  for (let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function setResult(msg, tone='neutral'){
  const styles = {neutral:'', good:'border-color: rgba(34,197,94,.5);', bad:'border-color: rgba(239,68,68,.5);', warn:'border-color: rgba(245,158,11,.5)'};
  resultEl.style = styles[tone] || '';
  resultEl.textContent = msg;
}
function scrollToBottom(){
  stackVisualEl.scrollTop = stackVisualEl.scrollHeight;
}
function playSuccessAnimation(){
  stackVisualEl.classList.add('success','success-pulse');
  const overlay = document.createElement('div');
  overlay.className = 'success-overlay';
  overlay.innerHTML = `<div class="success-badge">‚úÖ Geschafft!</div>`;
  stackVisualEl.appendChild(overlay);
  setTimeout(()=> {
    overlay.remove();
    stackVisualEl.classList.remove('success-pulse');
  }, 1100);
}
function playFailAnimation(){
  stackVisualEl.classList.add('fail-shake');
  setTimeout(()=>stackVisualEl.classList.remove('fail-shake'), 900);
}

// ---- Push / Toast (zentriert, nur per X)
function pushNotify(title, message){
  const container = document.getElementById('toasts');
  const t = document.createElement('div');
  t.className = 'toast';
  t.setAttribute('role','alertdialog');
  t.setAttribute('aria-modal','true');
  t.innerHTML = `
    <div class="icon">üîî</div>
    <div class="body">
      <div class="title">${title}</div>
      <div class="msg">${message}</div>
    </div>
    <button class="close" aria-label="Schlie√üen">√ó</button>
  `;
  container.innerHTML = ''; // nur 1 Toast gleichzeitig
  container.appendChild(t);

  const close = ()=> {
    t.style.animation = 'toastOut .22s ease forwards';
    setTimeout(()=> t.remove(), 200);
  };
  t.querySelector('.close').addEventListener('click', close);

  // ESC zum Schlie√üen
  const escHandler = (e)=>{ if(e.key === 'Escape'){ close(); window.removeEventListener('keydown', escHandler);} };
  window.addEventListener('keydown', escHandler);

  // Fokus aufs Close-Icon, damit Tastatur nutzbar ist
  setTimeout(()=> t.querySelector('.close')?.focus(), 0);
}

// ---- Pool-Markierung
function isOnStack(text){
  return stack.some(it => it.text === text);
}
function refreshPoolMarks(){
  document.querySelectorAll('.card').forEach(card=>{
    const text = card.dataset.text;
    if(isOnStack(text)){
      card.classList.add('in-stack');
      if(!card.querySelector('.chip')){
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.textContent = 'im Stack';
        card.appendChild(chip);
      }
    }else{
      card.classList.remove('in-stack');
      const chip = card.querySelector('.chip');
      if(chip) chip.remove();
    }
  });
}

// =========================
// Stack-Visualisierung (√§ltestes unten, neues dar√ºber; Top oben)
// =========================
function renderStack(){
  stackInnerEl.innerHTML='';
  for(let i=stack.length-1;i>=0;i--){
    const slot = document.createElement('div');
    slot.className = 'stack-slot filled';

    const lab = document.createElement('div');
    lab.className='slot-label';
    lab.textContent = `#${i}`;
    slot.appendChild(lab);

    if(showTop && i === stack.length-1){
      const content = document.createElement('div');
      content.className='slot-content';
      content.textContent = stack[i].text;
      slot.appendChild(content);
    }

    stackInnerEl.appendChild(slot);
  }
  scrollToBottom();
  refreshPoolMarks(); // Pool-Markierungen nach jedem Update
}

// =========================
// Pool & Auswahl
// =========================
function buildTaskList(){
  taskListEl.innerHTML='';
  TASKS.forEach((t,i)=>{
    const el = document.createElement('div'); el.className='task'; el.dataset.taskId=t.id;

    // Linear freischalten
    const prevId = TASKS[i-1]?.id;
    const locked = (i>0 && !taskCompleted(prevId));
    if(locked) el.classList.add('locked');

    if(currentTask && currentTask.id===t.id) el.classList.add('active');
    el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
      <div>
        <div style="font-weight:700">${t.title}</div>
        <div class="small">${t.description}</div>
      </div>
      <span class="badge">${t.target.length} Schritte</span>
    </div>`;
    el.addEventListener('click', ()=> {
      if(el.classList.contains('locked')) return;
      loadTask(t.id);
    });
    taskListEl.appendChild(el);
  });

  // Creator-Button aktivieren, wenn Standardaufgaben abgeschlossen
  btnOpenCreator.disabled = !allDefaultCompleted();
}

function renderPool(){
  poolEl.innerHTML='';
  // Reihenfolge fixieren und speichern (damit sp√§tere Refreshes nicht mischen)
  poolOrder = shuffle(currentTask.target);
  poolOrder.forEach(text=>{
    const el = document.createElement('div');
    el.className='card';
    el.dataset.text = text;
    el.innerHTML = `<div class="title">${text}</div><div class="desc">anklicken ‚Üí Push</div>`;
    el.addEventListener('click', ()=> selectCard(el, text));
    poolEl.appendChild(el);
  });

  refreshPoolMarks(); // direkt nach Rendern markieren

  // Auswahl, falls vorhanden, wiederherstellen
  if(selectedCard){
    const found = [...document.querySelectorAll('.card')].find(c=>c.dataset.text===selectedCard);
    if(found) found.classList.add('selected');
  }
}

function selectCard(el, text){
  document.querySelectorAll('.card').forEach(c=>c.classList.remove('selected'));
  el.classList.add('selected');
  selectedCard = text;
  setResult(`Ausgew√§hlt: ‚Äû${text}‚Äú ‚Üí jetzt Push.`);
}

// =========================
// Stack-Operationen
// =========================
function pushSelected(){
  if(!selectedCard){ setResult('Keine Karte ausgew√§hlt. Bitte im Karten-Pool anklicken.', 'warn'); return; }
  stack.push({ text: selectedCard });
  showTop = false;
  renderStack();
  setResult(`push: ‚Äû${selectedCard}‚Äú`);
}

function popAction(){
  if(stack.length===0){ setResult('Stack ist leer.', 'warn'); return; }

  const card = stack.pop();
  const expected = currentTask.target[poppedSoFar.length];

  if(card.text !== expected){
    // Fortschritt zur√ºcksetzen
    poppedSoFar = [];
    showTop = false;
    renderStack();
    playFailAnimation();
    setResult(`pop: ‚Äû${card.text}‚Äú ‚Äì erwartet w√§re ‚Äû${expected}‚Äú. Fortschritt zur√ºckgesetzt (erwartet wieder: ‚Äû${currentTask.target[0]}‚Äú).`, 'bad');
    return;
  }

  // korrekt
  poppedSoFar.push(card.text);
  showTop = false;
  renderStack();
  setResult(`pop: ‚úì ‚Äû${card.text}‚Äú`, 'good');

  // fertig?
  if(poppedSoFar.length === currentTask.target.length){
    playSuccessAnimation();
    unlockCurrentAndRefresh();

    if(allDefaultCompleted()){
      btnOpenCreator.disabled = false;

      // ZENTRIERTE Push-Nachricht, bleibt bis ‚ÄûX‚Äú
      pushNotify(
        'Alle Aufgaben geschafft!',
        'Erstellt jetzt eine eigene Aufgabe, tauscht sie mit eurem Sitznachbarn und l√∂st die Aufgabe des anderen.'
      );
    } else {
      setResult('üéâ Aufgabe korrekt gel√∂st! N√§chste Aufgabe freigeschaltet.', 'good');
    }
  }
}

function peekTop(){
  if(stack.length===0){ setResult('peek: ‚Äî (Stack leer).', 'warn'); return; }
  showTop = true; renderStack(); setResult('peek: oberstes Element sichtbar (oben).');
}

function resetAll(){
  stack = []; poppedSoFar = []; selectedCard = null; showTop = false;
  document.querySelectorAll('.card').forEach(c=>c.classList.remove('selected'));
  stackVisualEl.classList.remove('success','success-pulse','fail-shake');
  renderPool(); renderStack();
  setResult('Zur√ºckgesetzt.');
}

// =========================
// Aufgaben wechseln / Fortschritt
// =========================
function taskCompleted(id){
  return window.__completedTasks?.has(id);
}
function unlockCurrentAndRefresh(){
  window.__completedTasks = window.__completedTasks || new Set();
  window.__completedTasks.add(currentTask.id);
  buildTaskList();
}
function allDefaultCompleted(){
  const need = ['kaffee','informatik','arith1'];
  const done = window.__completedTasks || new Set();
  return need.every(id => done.has(id));
}
function loadTask(id){
  const t = TASKS.find(x=>x.id===id) || TASKS[0];
  currentTask = t;
  document.querySelectorAll('.task').forEach(e=>e.classList.remove('active'));
  const active = document.querySelector(`.task[data-task-id="${t.id}"]`);
  if(active) active.classList.add('active');
  resetAll();
  setResult(`Aufgabe geladen: ${t.title}. Karte anklicken ‚Üí Push. Mit Pop arbeitest du ab.`);
}

// =========================
// Geheim: Alt + U ‚Üí Alle Aufgaben freischalten (ohne Hinweis)
// =========================
function unlockAllTasksSecret(){
  window.__completedTasks = new Set(TASKS.map(t=>t.id)); // alles frei
  buildTaskList();
  setResult('üîì Geheimer Modus: Alle Aufgaben freigeschaltet.', 'good');
}
window.addEventListener('keydown', (e)=>{
  if(e.altKey && (e.key === 'u' || e.key === 'U')){
    e.preventDefault();
    unlockAllTasksSecret();
  }
});

// =========================
// Creator-Logik (Eigene Aufgabe)
// =========================
let creatorSteps = [];

function openCreatorPanel(){
  creatorEl.style.display = 'block';
  ctitle.focus();
}
function closeCreatorPanel(){
  creatorEl.style.display = 'none';
}

function refreshStepsList(){
  stepsList.innerHTML = '';
  if(creatorSteps.length === 0){
    const hint = document.createElement('div');
    hint.className = 'small';
    hint.textContent = 'Noch keine Schritte hinzugef√ºgt.';
    stepsList.appendChild(hint);
    return;
  }
  creatorSteps.forEach((txt, idx)=>{
    const row = document.createElement('div');
    row.className = 'step-item';
    row.style.display='flex'; row.style.alignItems='center'; row.style.gap='8px'; row.style.marginBottom='8px';

    const span = document.createElement('div');
    span.className = 'txt';
    span.textContent = `${idx+1}. ${txt}`;
    span.style.flex='1';
    span.style.padding='10px 12px';
    span.style.borderRadius='10px';
    span.style.background='rgba(255,255,255,.04)';
    span.style.border='1px solid rgba(255,255,255,.10)';
    row.appendChild(span);

    const up = document.createElement('button');
    up.className = 'btn mini secondary';
    up.textContent = '‚Üë';
    up.onclick = ()=>{ if(idx>0){ [creatorSteps[idx-1],creatorSteps[idx]]=[creatorSteps[idx],creatorSteps[idx-1]]; refreshStepsList(); } };
    row.appendChild(up);

    const down = document.createElement('button');
    down.className = 'btn mini secondary';
    down.textContent = '‚Üì';
    down.onclick = ()=>{ if(idx<creatorSteps.length-1){ [creatorSteps[idx+1],creatorSteps[idx]]=[creatorSteps[idx],creatorSteps[idx+1]]; refreshStepsList(); } };
    row.appendChild(down);

    const del = document.createElement('button');
    del.className = 'btn mini warn';
    del.textContent = 'L√∂schen';
    del.onclick = ()=>{ creatorSteps.splice(idx,1); refreshStepsList(); };
    row.appendChild(del);

    stepsList.appendChild(row);
  });
}

btnOpenCreator.addEventListener('click', ()=>{
  if(btnOpenCreator.disabled) return;
  if(creatorEl.style.display === 'block'){ closeCreatorPanel(); }
  else { openCreatorPanel(); }
});

btnAddStep.addEventListener('click', (e)=>{
  e.preventDefault();
  const val = cstepInput.value.trim();
  if(!val) return;
  creatorSteps.push(val);
  cstepInput.value = '';
  refreshStepsList();
});

btnCancelCreator.addEventListener('click', ()=>{
  ctitle.value = '';
  cdesc.value = '';
  cstepInput.value = '';
  creatorSteps = [];
  refreshStepsList();
  closeCreatorPanel();
});

btnSaveTask.addEventListener('click', ()=>{
  const title = ctitle.value.trim();
  const desc = cdesc.value.trim();
  if(!title){ setResult('Bitte einen Titel eingeben.', 'warn'); return; }
  if(creatorSteps.length < 2){ setResult('Bitte mindestens zwei Schritte hinzuf√ºgen.', 'warn'); return; }

  const newTask = {
    id: 'custom_' + Date.now(),
    title,
    description: desc || 'Eigene Aufgabe (POP-Reihenfolge).',
    target: [...creatorSteps]
  };

  TASKS.push(newTask);
  setResult(`Eigene Aufgabe ‚Äû${title}‚Äú erstellt.`, 'good');

  // Formular zur√ºcksetzen & Aufgabe laden
  btnCancelCreator.click();
  buildTaskList();
  loadTask(newTask.id);
});

// =========================
// Init
// =========================
buildTaskList();
loadTask('kaffee'); // Kaffee zuerst

btnPush.addEventListener('click', pushSelected);
btnPop.addEventListener('click', popAction);
btnPeek.addEventListener('click', peekTop);
btnReset.addEventListener('click', resetAll);

// Startnachricht
setResult('Starte mit ‚ÄûKaffee (French Press)‚Äú. Danach ‚ÄûTypische Informatikstunde‚Äú und ‚ÄûMathe‚Äú.');
</script>
</body>
</html>
